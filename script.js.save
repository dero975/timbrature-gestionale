function registraTimbratura(tipo) {
  const pin = document.getElementById("pin").value.trim();
  if (!pin) return alert("Inserisci un PIN!");

  const utenti = JSON.parse(localStorage.getItem("dipendenti") || "[]");
  const utente = utenti.find(u => u.pin === pin);
  if (!utente) return alert("Utente non trovato!");

  const oggi = new Date().toISOString().split("T")[0];
  const ora = new Date().toTimeString().split(" ")[0].slice(0, 5); // HH:mm

  const storico = JSON.parse(localStorage.getItem("storico") || "{}");
  if (!storico[pin]) storico[pin] = {};
  if (!storico[pin][oggi]) storico[pin][oggi] = [];

  const sessioni = storico[pin][oggi];

  if (tipo === "entrata") {
    // Aggiunge una nuova sessione con solo lâ€™entrata
    sessioni.push({ entrata: ora, uscita: "" });
    mostraMessaggio(`${utente.nome} ${utente.cognome}\nENTRATA CONFERMATA\nore ${ora}`);
  } else if (tipo === "uscita") {
    const ultima = sessioni.reverse().find(s => s.uscita === "");
    if (ultima) {
      ultima.uscita = ora;
      mostraMessaggio(`${utente.nome} ${utente.cognome}\nUSCITA CONFERMATA\nore ${ora}`);
    } else {
      alert("Devi prima registrare un'entrata.");
      return;
    }
  }

  localStorage.setItem("storico", JSON.stringify(storico));
  aggiornaUltimaTimbratura(pin);
}

